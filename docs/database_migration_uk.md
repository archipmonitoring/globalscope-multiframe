# Процедури міграції бази даних GlobalScope MultiFrame 11.0

## Огляд
Цей документ надає покрокові процедури для міграції даних бази даних у GlobalScope MultiFrame 11.0. Система використовує Redis як основне сховище даних, а процедури міграції розроблено для забезпечення цілісності даних і мінімізації простою під час оновлень або змін системи.

## Типи міграції

### 1. Міграція оновлення версії
Процедури міграції під час оновлення до нової версії GlobalScope MultiFrame.

### 2. Міграція зміни схеми
Процедури міграції, коли потрібні зміни схеми бази даних.

### 3. Міграція передачі даних
Процедури міграції для передачі даних між різними екземплярами Redis або середовищами.

## Передумови

Перед виконанням будь-якої міграції переконайтеся, що у вас є:

1. **Резервна копія**: Повна резервна копія поточної бази даних
2. **Вікно простою**: Заплановане вікно обслуговування для середовищ виробництва
3. **Тестове середовище**: Доступ до тестового середовища, яке відображає виробниче
4. **Скрипти міграції**: Усі необхідні скрипти міграції та інструменти
5. **План відкату**: Процедура повернення змін, якщо міграція не вдасться
6. **Інструменти моніторингу**: Інструменти для моніторингу процесу міграції

## Процедури міграції

### Міграція оновлення версії

#### Крок 1: Підготовка перед міграцією
1. Перевірте поточну версію системи:
   ```bash
   redis-cli GET config:system
   ```
2. Перевірте цілісність даних:
   ```bash
   python verify_demo_data.py
   ```
3. Створіть повну резервну копію (див. документацію Резервне копіювання та відновлення)
4. Задокументуйте поточну кількість ключів:
   ```bash
   redis-cli DBSIZE
   ```

#### Крок 2: Підготовка системи
1. Зупиніть усі служби додатків:
   ```bash
   # Якщо використовуєте Docker
   cd src
   docker-compose down
   ```
2. Переконайтеся, що Redis все ще доступний:
   ```bash
   redis-cli ping
   ```
3. Експортуйте поточні дані за потреби:
   ```bash
   redis-cli --scan --pattern "*" > key_list.txt
   ```

#### Крок 3: Виконання оновлення
1. Оновіть код додатка до нової версії
2. Оновіть залежності за потреби:
   ```bash
   pip install -r requirements.txt
   ```
3. Запустіть Redis (якщо він ще не запущений):
   ```bash
   redis-server
   ```

#### Крок 4: Міграція даних
1. Якщо потрібні зміни схеми, запустіть скрипти міграції:
   ```bash
   python migrate_data.py
   ```
2. Перевірте цілісність даних після міграції:
   ```bash
   python verify_demo_data.py
   ```

#### Крок 5: Пост-міграційна валідація
1. Запустіть служби додатків:
   ```bash
   # Якщо використовуєте Docker
   cd src
   docker-compose up -d
   ```
2. Перевірте функціональність додатка:
   - Протестуйте ендпоінти API
   - Перевірте вхід користувача
   - Перевірте доступ до даних
3. Моніторьте продуктивність системи та журнали

### Міграція зміни схеми

#### Крок 1: Аналіз схеми
1. Визначте необхідні зміни схеми
2. Задокументуйте відмінності між поточною та цільовою схемами
3. Створіть план міграції для кожного типу сутності

#### Крок 2: Розробка скрипта міграції
1. Створіть скрипт міграції для кожної зміни схеми:
   ```python
   # migrate_schema.py
   import asyncio
   import json
   from redis.asyncio import Redis
   
   async def migrate_schema():
       redis_client = Redis(host="localhost", port=6379, decode_responses=True)
       
       try:
           # Приклад: Додати нове поле до всіх записів користувачів
           user_keys = await redis_client.keys("user:*")
           for user_key in user_keys:
               user_data = await redis_client.get(user_key)
               user = json.loads(user_data)
               
               # Додати нове поле, якщо воно не існує
               if 'last_login' not in user:
                   user['last_login'] = None
                   
               # Зберегти оновлені дані користувача
               await redis_client.set(user_key, json.dumps(user))
               
           print(f"Мігровано {len(user_keys)} записів користувачів")
           
       except Exception as e:
           print(f"Помилка під час міграції схеми: {e}")
       finally:
           await redis_client.close()
   
   if __name__ == "__main__":
       asyncio.run(migrate_schema())
   ```

#### Крок 3: Тестування
1. Протестуйте скрипт міграції в середовищі розробки
2. Перевірте цілісність даних до та після міграції
3. Протестуйте процедури відкату

#### Крок 4: Міграція у виробництві
1. Виконайте кроки 1-3 міграції оновлення версії
2. Виконайте скрипт міграції схеми:
   ```bash
   python migrate_schema.py
   ```
3. Виконайте кроки 4-5 міграції оновлення версії

### Міграція передачі даних

#### Крок 1: Підготовка вихідного середовища
1. Переконайтеся, що вихідний Redis доступний
2. Задокументуйте статистику вихідних даних:
   ```bash
   redis-cli DBSIZE
   redis-cli INFO keyspace
   ```

#### Крок 2: Експорт даних
1. Експортуйте всі дані за допомогою дампу Redis:
   ```bash
   redis-cli --rdb backup.rdb
   ```
2. Або експортуйте конкретні ключі:
   ```bash
   # Експортуйте конкретні шаблони
   redis-cli --scan --pattern "user:*" > user_keys.txt
   redis-cli --scan --pattern "driver:*" > driver_keys.txt
   ```

#### Крок 3: Передача даних
1. Безпечно передайте файли резервних копій до цільового середовища
2. Перевірте цілісність файлів за допомогою контрольних сум:
   ```bash
   md5sum backup.rdb
   ```

#### Крок 4: Імпорт даних
1. Зупиніть Redis у цільовому середовищі
2. Замініть файл даних Redis резервною копією:
   ```bash
   # Зупиніть Redis
   redis-cli shutdown
   
   # Замініть файл дампу
   cp backup.rdb /var/lib/redis/dump.rdb
   
   # Запустіть Redis
   redis-server
   ```
3. Або імпортуйте конкретні ключі за допомогою скриптів:
   ```python
   # import_data.py
   import asyncio
   import json
   from redis.asyncio import Redis
   
   async def import_data():
       source_redis = Redis(host="source_host", port=6379, decode_responses=True)
       target_redis = Redis(host="target_host", port=6379, decode_responses=True)
       
       try:
           # Імпортуйте користувачів
           user_keys = await source_redis.keys("user:*")
           for user_key in user_keys:
               user_data = await source_redis.get(user_key)
               await target_redis.set(user_key, user_data)
               
           print(f"Імпортовано {len(user_keys)} записів користувачів")
           
       except Exception as e:
           print(f"Помилка під час імпорту даних: {e}")
       finally:
           await source_redis.close()
           await target_redis.close()
   
   if __name__ == "__main__":
       asyncio.run(import_data())
   ```

## Найкращі практики міграції

### 1. Завжди створюйте резервну копію спочатку
- Створіть повну резервну копію перед будь-якою міграцією
- Перевірте цілісність резервної копії
- Зберігайте резервні копії в безпечних, доступних місцях

### 2. Тестуйте в staging
- Тестуйте всі процедури міграції в staging середовищі
- Перевіряйте цілісність даних до та після міграції
- Тестуйте процедури відкату

### 3. Моніторьте під час міграції
- Моніторьте системні ресурси (CPU, пам'ять, диск)
- Моніторьте метрики продуктивності Redis
- Записуйте всі кроки міграції та результати

### 4. Плануйте відкат
- Задокументуйте процедури відкату для кожного типу міграції
- Протестуйте процедури відкату в staging
- Переконайтеся, що відкат можна виконати швидко за потреби

### 5. Комунікуйте з зацікавленими сторонами
- Повідомте користувачів про запланований простій
- Надавайте регулярні оновлення під час міграції
- Негайно повідомляйте про успіх або проблеми

## Поширені проблеми міграції та їх вирішення

### 1. Пошкодження даних
**Проблема**: Дані пошкоджуються під час міграції
**Рішення**: 
- Використовуйте резервну копію для відновлення попереднього стану
- Перевіряйте цілісність даних до та після міграції
- Використовуйте атомарні операції, коли це можливо

### 2. Зниження продуктивності
**Проблема**: Продуктивність системи знижується після міграції
**Рішення**:
- Моніторьте метрики продуктивності Redis
- Перевірте наявність неефективних структур даних
- Оптимізуйте запити та шаблони доступу до даних

### 3. Проблеми сумісності
**Проблема**: Нова версія несумісна з існуючими даними
**Рішення**:
- Ретельно тестуйте в staging середовищі
- Реалізуйте належні скрипти міграції схеми
- Майте готовий план відкату

## Процедури відкату

### Відкат оновлення версії
1. Зупиніть служби додатків
2. Відновіть базу даних з резервної копії:
   ```bash
   # Зупиніть Redis
   redis-cli shutdown
   
   # Відновіть з резервної копії
   cp backup.rdb /var/lib/redis/dump.rdb
   
   # Запустіть Redis
   redis-server
   ```
3. Поверніть код додатка до попередньої версії
4. Запустіть служби додатків
5. Перевірте функціональність системи

### Відкат зміни схеми
1. Зупиніть служби додатків
2. Запустіть скрипт зворотної міграції, якщо він доступний:
   ```bash
   python reverse_migrate_schema.py
   ```
3. Або відновіть базу даних з резервної копії
4. Запустіть служби додатків
5. Перевірте функціональність системи

## Інструменти міграції

### Вбудовані інструменти
1. **clear_database.py** - Очищує всі дані з Redis
2. **init_demo_data.py** - Ініціалізує базу даних демонстраційними даними
3. **verify_demo_data.py** - Перевіряє цілісність даних бази даних

### Інструменти Redis CLI
1. **redis-cli** - Інтерфейс командного рядка для Redis
2. **redis-benchmark** - Інструмент тестування продуктивності
3. **redis-check-rdb** - Перевірка цілісності файлів RDB

### Спеціальні скрипти міграції
1. **migrate_schema.py** - Скрипти міграції схеми (потрібно розробити)
2. **import_data.py** - Скрипти імпорту даних (потрібно розробити)
3. **export_data.py** - Скрипти експорту даних (потрібно розробити)

## Моніторинг та валідація

### Передміграційна валідація
- Перевірте цілісність даних
- Задокументуйте поточний стан системи
- Протестуйте відновлення з резервної копії

### Моніторинг під час міграції
- Моніторьте системні ресурси
- Відстежуйте прогрес міграції
- Записуйте всі операції

### Постміграційна валідація
- Перевірте цілісність даних
- Протестуйте функціональність додатка
- Моніторьте продуктивність системи

## Аварійні процедури

### Невдала міграція
1. Негайно зупиніть процес міграції
2. Оцініть вплив невдачі
3. Виконайте процедури відкату
4. Дослідіть основну причину
5. Комунікуйте з зацікавленими сторонами

### Втрата даних
1. Зупиніть усі операції запису
2. Відновіть з найновішої резервної копії
3. Перевірте цілісність даних
4. Відновіть операції
5. Впровадьте запобіжні заходи

## Оновлення документації
Після кожної міграції:
1. Оновіть цей документ з усіма змінами процедур
2. Задокументуйте будь-які виявлені проблеми та їх рішення
3. Оновіть матрицю сумісності версій
4. Перегляньте та оновіть процедури відкату