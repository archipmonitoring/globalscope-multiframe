# Стратегії резервного копіювання та відновлення GlobalScope MultiFrame 11.0

## Огляд
Цей документ надає комплексні стратегії резервного копіювання та відновлення для GlobalScope MultiFrame 11.0. Система використовує Redis як основне сховище даних, і ця документація визначає процедури для захисту цілісності даних і забезпечення швидкого відновлення у разі збоїв системи.

## Стратегії резервного копіювання

### 1. Персистентність Redis RDB
Redis надає вбудоване знімкове (RDB) збереження, яке створює знімки набору даних у визначені інтервали часу.

#### Конфігурація
Конфігурація Redis за замовчуванням вмикає персистентність RDB з наступними точками збереження:
```
save 900 1    # Зберегти через 900 секунд, якщо змінився хоча б 1 ключ
save 300 10   # Зберегти через 300 секунд, якщо змінилося хоча б 10 ключів
save 60 10000 # Зберегти через 60 секунд, якщо змінилося хоча б 10000 ключів
```

#### Процедура резервного копіювання RDB
1. **Автоматичні резервні копії**: Redis автоматично створює знімки RDB на основі налаштованих точок збереження
2. **Ручне резервне копіювання**: Створіть негайну резервну копію за допомогою команди SAVE або BGSAVE:
   ```bash
   # Синхронне збереження (блокує Redis)
   redis-cli SAVE
   
   # Асинхронне збереження (не блокує)
   redis-cli BGSAVE
   ```
3. **Розташування резервних копій**: Файли RDB зберігаються в робочому каталозі Redis як `dump.rdb`

#### Найкращі практики резервного копіювання RDB
- Моніторьте місце на диску, щоб забезпечити достатній простір для файлів RDB
- Регулярно перевіряйте цілісність файлів RDB:
  ```bash
  redis-check-rdb dump.rdb
  ```
- Зберігайте файли RDB у безпечних, віддалених місцях
- Регулярно тестуйте відновлення файлів RDB

### 2. Персистентність Redis AOF (Append Only File)
Персистентність AOF реєструє кожну операцію запису, отриману сервером, забезпечуючи кращу надійність за рахунок продуктивності.

#### Конфігурація
Увімкніть персистентність AOF у redis.conf:
```
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
```

#### Процедура резервного копіювання AOF
1. **Автоматичне логування**: Redis автоматично реєструє всі операції запису у файлі AOF
2. **Перезапис AOF**: Періодично перезаписуйте файл AOF для зменшення його розміру:
   ```bash
   redis-cli BGREWRITEAOF
   ```
3. **Розташування резервних копій**: Файли AOF зберігаються в робочому каталозі Redis

#### Найкращі практики резервного копіювання AOF
- Моніторьте розмір файлу AOF та вплив на продуктивність
- Регулярно виконуйте перезапис AOF для керування розміром файлу
- Зберігайте файли AOF у безпечних, віддалених місцях
- Регулярно тестуйте відновлення файлів AOF

### 3. Експорт даних вручну
Для додаткового захисту вручну експортуйте конкретні набори даних.

#### Процедура експорту
1. **Експорт усіх ключів**:
   ```bash
   redis-cli --scan > all_keys.txt
   ```
2. **Експорт конкретних шаблонів**:
   ```bash
   redis-cli --scan --pattern "user:*" > user_keys.txt
   redis-cli --scan --pattern "driver:*" > driver_keys.txt
   ```
3. **Експорт даних**:
   ```bash
   # Експортуйте конкретні ключі у JSON
   python export_data.py
   ```

#### Приклад скрипта експорту
```python
# export_data.py
import asyncio
import json
from redis.asyncio import Redis

async def export_data():
    redis_client = Redis(host="localhost", port=6379, decode_responses=True)
    
    try:
        # Експортуйте користувачів
        user_keys = await redis_client.keys("user:*")
        users_data = {}
        
        for user_key in user_keys:
            user_data = await redis_client.get(user_key)
            users_data[user_key] = user_data
            
        # Збережіть у файл
        with open('users_backup.json', 'w') as f:
            json.dump(users_data, f, indent=2)
            
        print(f"Експортовано {len(user_keys)} записів користувачів")
        
    except Exception as e:
        print(f"Помилка під час експорту даних: {e}")
    finally:
        await redis_client.close()

if __name__ == "__main__":
    asyncio.run(export_data())
```

### 4. Автоматизація планового резервного копіювання
Впровадіть автоматизовані процедури резервного копіювання за допомогою cron-завдань або подібних інструментів планування.

#### Приклад Cron-завдання
```bash
# Щоденне резервне копіювання RDB о 2:00
0 2 * * * /usr/local/bin/redis-cli BGSAVE && cp /var/lib/redis/dump.rdb /backup/redis/dump_$(date +\%Y\%m\%d).rdb

# Щотижневе резервне копіювання AOF у неділю о 3:00
0 3 * * 0 /usr/local/bin/redis-cli BGREWRITEAOF && cp /var/lib/redis/appendonly.aof /backup/redis/aof_$(date +\%Y\%m\%d).aof
```

## Стратегії відновлення

### 1. Відновлення RDB
Відновіть дані з знімків RDB за потреби.

#### Процедура відновлення
1. **Зупиніть сервер Redis**:
   ```bash
   redis-cli shutdown
   ```
2. **Замініть файл RDB**:
   ```bash
   cp /backup/redis/dump_latest.rdb /var/lib/redis/dump.rdb
   ```
3. **Запустіть сервер Redis**:
   ```bash
   redis-server
   ```
4. **Перевірте відновлення**:
   ```bash
   redis-cli DBSIZE
   redis-cli GET config:system
   ```

### 2. Відновлення AOF
Відновіть дані з файлів AOF за потреби.

#### Процедура відновлення
1. **Зупиніть сервер Redis**:
   ```bash
   redis-cli shutdown
   ```
2. **Замініть файл AOF**:
   ```bash
   cp /backup/redis/appendonly_latest.aof /var/lib/redis/appendonly.aof
   ```
3. **Виправіть файл AOF (за потреби)**:
   ```bash
   redis-check-aof --fix appendonly.aof
   ```
4. **Запустіть сервер Redis**:
   ```bash
   redis-server
   ```
5. **Перевірте відновлення**:
   ```bash
   redis-cli DBSIZE
   redis-cli GET config:system
   ```

### 3. Імпорт даних вручну
Відновіть конкретні набори даних з експортованих файлів.

#### Процедура імпорту
1. **Скрипт імпорту**:
   ```python
   # import_data.py
   import asyncio
   import json
   from redis.asyncio import Redis

   async def import_data():
       redis_client = Redis(host="localhost", port=6379, decode_responses=True)
       
       try:
           # Завантажте з файлу резервної копії
           with open('users_backup.json', 'r') as f:
               users_data = json.load(f)
               
           # Імпортуйте користувачів
           for user_key, user_data in users_data.items():
               await redis_client.set(user_key, user_data)
               
           print(f"Імпортовано {len(users_data)} записів користувачів")
           
       except Exception as e:
           print(f"Помилка під час імпорту даних: {e}")
       finally:
           await redis_client.close()

   if __name__ == "__main__":
       asyncio.run(import_data())
   ```
2. **Запустіть скрипт імпорту**:
   ```bash
   python import_data.py
   ```

### 4. Аварійне відновлення
Повні процедури відновлення системи для катастрофічних збоїв.

#### Процедура аварійного відновлення
1. **Оцініть збитки**: Визначте ступінь втрати даних і пошкодження системи
2. **Визначте останню резервну копію**: Знайдіть найновішу дійсну резервну копію
3. **Підготуйте середовище відновлення**: Налаштуйте чистий екземпляр Redis
4. **Відновіть дані**: Використовуйте відповідний метод відновлення (RDB, AOF або ручний імпорт)
5. **Перевірте цілісність даних**: Перевірте узгодженість і повноту даних
6. **Протестуйте функціональність системи**: Переконайтеся, що всі компоненти системи працюють правильно
7. **Відновіть операції**: Поступово поверніть систему в онлайн

## Рекомендації щодо частоти резервного копіювання

### Середовище виробництва
- **Знімки RDB**: Кожні 4 години під час пікового навантаження
- **Журнали AOF**: Кожну секунду (безперервно)
- **Ручний експорт**: Щодня для критичних наборів даних
- **Повні резервні копії**: Щотижня до віддаленого сховища

### Середовище розробки
- **Знімки RDB**: Щодня
- **Журнали AOF**: Кожні 5 секунд
- **Ручний експорт**: Щотижня
- **Повні резервні копії**: Щомісяця

### Середовище тестування
- **Знімки RDB**: Щотижня
- **Журнали AOF**: Кожні 30 секунд
- **Ручний експорт**: Щомісяця
- **Повні резервні копії**: Щокварталу

## Моніторинг та валідація

### Моніторинг резервного копіювання
1. **Автоматичні сповіщення**: Налаштуйте сповіщення про збої резервного копіювання
2. **Перевірка резервних копій**: Регулярно перевіряйте цілісність файлів резервних копій
3. **Моніторинг місця на диску**: Моніторьте доступне місце на диску для резервних копій
4. **Вплив на продуктивність**: Моніторьте продуктивність системи під час операцій резервного копіювання

### Тестування відновлення
1. **Регулярне тестування**: Тестуйте процедури відновлення щомісяця
2. **Перевірка цілісності даних**: Перевіряйте узгодженість даних після відновлення
3. **Перевірка продуктивності**: Переконайтеся, що продуктивність системи прийнятна після відновлення
4. **Оновлення документації**: Оновіть процедури на основі результатів тестів

## Міркування щодо безпеки

### Безпека резервного копіювання
1. **Шифрування**: Шифруйте файли резервних копій під час зберігання
2. **Контроль доступу**: Обмежте доступ до файлів резервних копій
3. **Безпека передачі**: Використовуйте безпечні протоколи для передачі резервних копій
4. **Аудит логування**: Записуйте всі операції резервного копіювання та відновлення

### Безпека відновлення
1. **Автентифікація**: Вимагайте автентифікацію для операцій відновлення
2. **Авторизація**: Обмежте операції відновлення авторизованим персоналом
3. **Перевірка даних**: Перевіряйте цілісність даних до та після відновлення
4. **Аудиторський слід**: Ведіть аудиторський слід всіх операцій відновлення

## Стратегії зберігання резервних копій

### Локальне зберігання
- **Переваги**: Швидкий доступ, низька вартість
- **Недоліки**: Вразливість до локальних катастроф
- **Найкраща практика**: Використовуйте для частого резервного копіювання з віддаленими копіями

### Мережеве зберігання
- **Переваги**: Централізоване керування, краща надмірність
- **Недоліки**: Залежність від мережі, потенційна затримка
- **Найкраща практика**: Використовуйте для щоденних резервних копій з локальними копіями

### Хмарне зберігання
- **Переваги**: Географічна надмірність, масштабованість
- **Недоліки**: Вартість пропускної здатності, залежність від постачальника хмарних послуг
- **Найкраща практика**: Використовуйте для щотижневих/щомісячних резервних копій

### Гібридний підхід
- Поєднайте локальне, мережеве та хмарне зберігання для оптимального захисту
- Використовуйте локальне зберігання для частого резервного копіювання
- Використовуйте мережеве зберігання для щоденних резервних копій
- Використовуйте хмарне зберігання для щотижневих/щомісячних резервних копій

## Цілі часу відновлення (RTO) та цілі точки відновлення (RPO)

### Цілі RTO
- **Критичні дані**: 1 година
- **Важливі дані**: 4 години
- **Стандартні дані**: 24 години

### Цілі RPO
- **Критичні дані**: 1 хвилина
- **Важливі дані**: 1 година
- **Стандартні дані**: 24 години

## Вирішення поширених проблем

### 1. Збої резервного копіювання
**Проблема**: Резервне копіювання не вдається завершити
**Рішення**:
- Перевірте наявність місця на диску
- Перевірте конфігурацію Redis
- Моніторьте системні ресурси
- Перегляньте журнали Redis на наявність помилок

### 2. Збої відновлення
**Проблема**: Відновлення даних не вдається
**Рішення**:
- Перевірте цілісність файлу резервної копії
- Перевірте дозволи на файл
- Перегляньте журнали Redis на наявність помилок
- Протестуйте з меншими наборами даних

### 3. Зниження продуктивності
**Проблема**: Продуктивність системи знижується під час резервного копіювання
**Рішення**:
- Заплануйте резервне копіювання під час періодів низького навантаження
- Використовуйте BGSAVE замість SAVE
- Оптимізуйте конфігурацію Redis
- Оновіть системні ресурси

## Процедури обслуговування

### Регулярне обслуговування
1. **Очищення файлів резервних копій**: Видаляйте старі файли резервних копій відповідно до політики зберігання
2. **Оновлення системи**: Підтримуйте Redis та системне програмне забезпечення в актуальному стані
3. **Перегляд конфігурацій**: Регулярно переглядайте та оновлюйте конфігурації резервного копіювання
4. **Оновлення процедур**: Оновіть процедури на основі змін системи

### Щоквартальні перегляди
1. **Тестування аварійного відновлення**: Повне тестування аварійного відновлення
2. **Перегляд стратегії резервного копіювання**: Оцініть та оновіть стратегії резервного копіювання
3. **Перегляд безпеки**: Перегляньте заходи безпеки для резервних копій
4. **Оновлення документації**: Оновіть всю документацію щодо резервного копіювання та відновлення

## Аварійні процедури

### Негайні дії
1. **Зупиніть операції запису**: Запобігайте подальшим змінам даних
2. **Оцініть ситуацію**: Визначте